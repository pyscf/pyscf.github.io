
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyscf.pbc.cc.kintermediates_uhf &#8212; PySCF</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=92fd9be5" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/pyscf-pst.css?v=ed6b5f64" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../../_static/documentation_options.js?v=dfec817d"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pyscf/pbc/cc/kintermediates_uhf';</script>
    <link rel="icon" href="../../../../_static/favicon-32x32.png"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.7" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/logo-64x64.png" class="logo__image only-light" alt=""/>
    <img src="../../../../_static/logo-64x64.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">PySCF</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../contributor/index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../about.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../news.html">
    News
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pyscf/pyscf" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../contributor/index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../about.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../news.html">
    News
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pyscf/pyscf" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../pyscf.html" class="nav-link">pyscf</a></li>
    
    
    <li class="breadcrumb-item"><a href="../cc.html" class="nav-link">pyscf.pbc.cc</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">pyscf.pbc.cc.kintermediates_uhf</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pyscf.pbc.cc.kintermediates_uhf</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright 2017-2021 The PySCF Developers. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf.pbc.lib</span> <span class="kn">import</span> <span class="n">kpts_helper</span>

<span class="n">einsum</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span>

<span class="c1">#FIXME: the dtype of each intermediates. When the khf is at gamma point, the</span>
<span class="c1"># dtype is inconsistent between intermediates and t amplitudes</span>

<div class="viewcode-block" id="make_tau">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.make_tau">[docs]</a>
<span class="k">def</span> <span class="nf">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1p</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2aa</span><span class="p">)</span>

    <span class="n">tauaa</span> <span class="o">=</span> <span class="n">t2aa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tauab</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">taubb</span> <span class="o">=</span> <span class="n">t2bb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ib,ja-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ib-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ib,ja-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ib-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span></div>


<div class="viewcode-block" id="make_tau2">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.make_tau2">[docs]</a>
<span class="k">def</span> <span class="nf">make_tau2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1p</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2aa</span><span class="p">)</span>

    <span class="n">tauaa</span> <span class="o">=</span> <span class="n">t2aa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tauab</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">taubb</span> <span class="o">=</span> <span class="n">t2bb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*</span><span class="mf">.5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span></div>


<div class="viewcode-block" id="cc_Fvv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Fvv">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="n">tau_tildeaa</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="o">=</span><span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>
    <span class="n">fvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">nocc_a</span><span class="p">:,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">nocc_b</span><span class="p">:,</span><span class="n">nocc_b</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fvv</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fVV</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span><span class="n">fOV</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,emfa-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,emfa-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.5</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaF,meNF-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildebb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.5</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MnFa,MFne-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span></div>



<div class="viewcode-block" id="cc_Foo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Foo">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="n">tau_tildeaa</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="o">=</span><span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,:</span><span class="n">nocc_a</span><span class="p">]</span>
    <span class="n">fOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,:</span><span class="n">nocc_b</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">foo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fOO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ne-&gt;mn&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ne-&gt;mn&#39;</span><span class="p">,</span><span class="n">fOV</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,onma-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,onma-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tau_tildeaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.5</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNeF,meNF-&gt;mi&#39;</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;INEF,MENF-&gt;MI&#39;</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.5</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIeF,neMF-&gt;MI&#39;</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span></div>



<div class="viewcode-block" id="cc_Fov">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Fov">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">fov</span><span class="p">[</span><span class="n">km</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">fOV</span><span class="p">[</span><span class="n">km</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,mfne-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,nfme-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,mfne-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span></div>


<div class="viewcode-block" id="cc_Woooo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Woooo">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">tau_aa</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">,</span> <span class="n">tau_bb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">-=</span> <span class="n">tmp_aaaaJ</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">-=</span> <span class="n">tmp_bbbbJ</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">tmp_aabbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_baabJ</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie,xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">ki</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)</span>
            <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aaaaJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bbbbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aabbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp_baabJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">WOOOO</span> <span class="o">-</span> <span class="n">WOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Woooo</span><span class="p">,</span> <span class="n">WooOO</span><span class="p">,</span> <span class="n">WOOOO</span></div>



<div class="viewcode-block" id="cc_Wvvvv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Wvvvv">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="c1">#:wvvvv = eris.vvvv.copy()</span>
    <span class="c1">#:Wvvvv += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv = Wvvvv - Wvvvv.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">Wvvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#:WvvVV = eris.vvVV.copy()</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;xma,zxwemFB,zwxy-&gt;xzyaeBF&#39;, t1a, eris.voVV.conj(), P)</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;yMB,wyzFMea,wzyx-&gt;xzyaeBF&#39;, t1b, eris.VOvv.conj(), P)</span>
    <span class="n">WvvVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,emfb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">aebf</span>

    <span class="c1">#:WVVVV = eris.VVVV.copy()</span>
    <span class="c1">#:WVVVV += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV = WVVVV - WVVVV.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span></div>



<span class="c1">#TODO: merge cc_Wvvvv_half and cc_Wvvvv</span>
<div class="viewcode-block" id="cc_Wvvvv_half">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Wvvvv_half">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Wvvvv_half</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Similar to cc_Wvvvv, without anti-symmetrization&#39;&#39;&#39;</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="c1">#:wvvvv = eris.vvvv.copy()</span>
    <span class="c1">#:Wvvvv += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv = Wvvvv - Wvvvv.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">Wvvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>

    <span class="c1">#:WvvVV = eris.vvVV.copy()</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;xma,zxwemFB,zwxy-&gt;xzyaeBF&#39;, t1a, eris.voVV.conj(), P)</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;yMB,wyzFMea,wzyx-&gt;xzyaeBF&#39;, t1b, eris.VOvv.conj(), P)</span>
    <span class="n">WvvVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,emfb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">aebf</span>

    <span class="c1">#:WVVVV = eris.VVVV.copy()</span>
    <span class="c1">#:WVVVV += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV = WVVVV - WVVVV.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span></div>


<div class="viewcode-block" id="Wvvvv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Wvvvv">[docs]</a>
<span class="k">def</span> <span class="nf">Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">cc_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,menf-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,meNF-&gt;aeBF&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,menf-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span></div>


<div class="viewcode-block" id="get_Wvvvv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.get_Wvvvv">[docs]</a>
<span class="k">def</span> <span class="nf">get_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">kc</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;Lpv&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Using GDF to generate Wvvvv on the fly</span>
        <span class="n">Lpv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">Lpv</span>
        <span class="n">LPV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">LPV</span>
        <span class="n">Lac</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">Lbd</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">Lbc</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">Lad</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">LAC</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">LBD</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">LBC</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">LAD</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">vvvv</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lac</span><span class="p">,</span> <span class="n">Lbd</span><span class="p">)</span>
        <span class="n">vvvv</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lbc,Lad-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lbc</span><span class="p">,</span> <span class="n">Lad</span><span class="p">)</span>
        <span class="n">vvVV</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lac</span><span class="p">,</span> <span class="n">LBD</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">LAC</span><span class="p">,</span> <span class="n">LBD</span><span class="p">)</span>
        <span class="n">VVVV</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lbc,Lad-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">LBC</span><span class="p">,</span> <span class="n">LAD</span><span class="p">)</span>
        <span class="n">vvvv</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
        <span class="n">vvVV</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vvvv</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfa,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmeb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,mb,na-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>

        <span class="n">vvVV</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>

        <span class="n">VVVV</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfa,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmeb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,mb,na-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mcnf-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,mcNF-&gt;acBF&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mcnf-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">vvVV</span><span class="p">,</span> <span class="n">VVVV</span></div>


<div class="viewcode-block" id="cc_Wovvo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Wovvo">[docs]</a>
<span class="k">def</span> <span class="nf">cc_Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WoVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">vovv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">VOVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">voVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">VOvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
                <span class="c1">##### warnings for Ks</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>

                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>

                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                <span class="n">ooov_temp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">ooov_temp</span><span class="p">)</span>
                <span class="n">ooov_temp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">OOOV_temp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">OOOV_temp</span><span class="p">)</span>
                <span class="n">OOOV_temp</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,:,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:])</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:])</span>

                <span class="n">temp_ovOV_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">temp_ovOV_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                    <span class="n">temp_ovOV_1</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">temp_ovOV_2</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">kn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">][</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjfb,xnfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovOV_1</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_ovOV_1</span><span class="p">)</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnfb,xmfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovOV_2</span><span class="p">)</span>

                <span class="n">temp_OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_OVOV</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,:,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_OVOV</span><span class="p">)</span>
                <span class="n">temp_OVOV</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">temp_ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_ovov</span><span class="p">)</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjfb,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovov</span><span class="p">)</span>
                <span class="n">temp_ovov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span></div>


<span class="k">def</span> <span class="nf">_cc_Wovvo_k0k2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k2</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WoVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="c1">#:P = kconserv_mat(cc.nkpts, kconserv)</span>
    <span class="c1">#:Wovvo = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.voov, P).conj()</span>
    <span class="c1">#:WovVO = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.voOV, P).conj()</span>
    <span class="c1">#:WOVvo = np.einsum(&#39;wzybjia,xzyw-&gt;yxwiabj&#39;, eris.voOV, P)</span>
    <span class="c1">#:WOVVO = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.VOOV, P).conj()</span>
    <span class="c1">#:Wovvo-= np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.oovv, P)</span>
    <span class="c1">#:WOVVO-= np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.OOVV, P)</span>
    <span class="c1">#:WoVVo = np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.ooVV, -P)</span>
    <span class="c1">#:WOvvO = np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.OOvv, -P)</span>
    <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span>
        <span class="n">vovv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">VOVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">voVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">VOvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njfb,nfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,nfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
            <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,mfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,nemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">kn</span> <span class="o">==</span> <span class="n">k2</span> <span class="ow">and</span> <span class="n">kf</span> <span class="o">==</span> <span class="n">kj</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nemf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,menj-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nemf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,menj-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>

                <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,menf-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,nfme-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,mfne-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,nemf-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span>


<div class="viewcode-block" id="kconserv_mat">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.kconserv_mat">[docs]</a>
<span class="k">def</span> <span class="nf">kconserv_mat</span><span class="p">(</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">P</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">P</span></div>


<div class="viewcode-block" id="Foo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Foo">[docs]</a>
<span class="k">def</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Fova</span><span class="p">,</span> <span class="n">Fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">Fooa</span><span class="p">,</span> <span class="n">Foob</span> <span class="o">=</span> <span class="n">cc_Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">Fooa</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,me-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span><span class="n">Fova</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
        <span class="n">Foob</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,me-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span><span class="n">Fovb</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Fooa</span><span class="p">,</span> <span class="n">Foob</span></div>


<div class="viewcode-block" id="Fvv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Fvv">[docs]</a>
<span class="k">def</span> <span class="nf">Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Fova</span><span class="p">,</span> <span class="n">Fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">Fvva</span><span class="p">,</span> <span class="n">Fvvb</span> <span class="o">=</span> <span class="n">cc_Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">Fvva</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">Fova</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">Fvvb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">Fovb</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Fvva</span><span class="p">,</span> <span class="n">Fvvb</span></div>


<div class="viewcode-block" id="Fov">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Fov">[docs]</a>
<span class="k">def</span> <span class="nf">Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">Fme</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Fme</span></div>


<div class="viewcode-block" id="Wvvov">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Wvvov">[docs]</a>
<span class="k">def</span> <span class="nf">Wvvov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Wvvov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WvvOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kn</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">kn</span>
        <span class="n">Wvvov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WVVov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WvvOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WVVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Wvvov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,nemf-&gt;aemf&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">WvvOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,neMF-&gt;aeMF&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WVVov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NA,NEmf-&gt;AEmf&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WVVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NA,NEMF-&gt;AEMF&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">OVOV</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Wvvov</span><span class="p">,</span> <span class="n">WvvOV</span><span class="p">,</span> <span class="n">WVVov</span><span class="p">,</span> <span class="n">WVVOV</span></div>


<div class="viewcode-block" id="Wvvvo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Wvvvo">[docs]</a>
<span class="k">def</span> <span class="nf">Wvvvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">fova</span><span class="p">,</span> <span class="n">fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="n">Wvvvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WvvVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="c1"># - &lt;mb||ef&gt; t2(miaf)</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

            <span class="n">aebi</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;aebi&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">aebi</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFbe,iMaF-&gt;aebi&#39;</span><span class="p">,</span><span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebi</span>
            <span class="c1"># P(ab) for all alpha spin</span>
            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebi</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,iMfA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">OVvv</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,mIaF-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">ovVV</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">AEBI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEBF,MIAF-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">OVVV</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">AEBI</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfBE,mIfA-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">AEBI</span>
            <span class="c1"># P(ab) for all beta spin</span>
            <span class="n">WVVVO</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">AEBI</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># - t1(ma) (&lt;mb||ei&gt; - t2(nibf) &lt;mn||ef&gt;)</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">ka</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">ovVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tmp1aa</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,menf-&gt;mebi&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,meNF-&gt;mebi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,menf-&gt;meBI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1ab</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIBF,meNF-&gt;meBI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,MENF-&gt;MEbi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1ba</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,MEnf-&gt;MEbi&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

            <span class="n">tmp1bb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIBF,MENF-&gt;MEBI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,MEnf-&gt;MEBI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

        <span class="n">aebi</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mebi-&gt;aebi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">ovvo</span><span class="o">+</span><span class="n">tmp1aa</span><span class="p">))</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebi</span>

        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MEbi-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">OVvo</span><span class="o">+</span><span class="n">tmp1ba</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,meBI-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">ovVO</span><span class="o">+</span><span class="n">tmp1ab</span><span class="p">)</span>

        <span class="n">AEBI</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MEBI-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">OVVO</span><span class="o">+</span><span class="n">tmp1bb</span><span class="p">))</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">AEBI</span>


    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="c1"># P(ab) &lt;mb||ef&gt; t2(miaf) (alpha alpha beta beta) and (beta beta alpha alpha)</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span>
                    <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span>
                    <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfAE,mibf-&gt;AEbi&#39;</span><span class="p">,</span>
                                          <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEAF,iMbF-&gt;AEbi&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFae,MIBF-&gt;aeBI&#39;</span><span class="p">,</span>
                                          <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,mIfB-&gt;aeBI&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>

        <span class="c1"># P(ab) -t1(ma) (&lt;mb||ei&gt; - t2(nibf) &lt;mn||ef&gt;) for all spin configurations</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">kb</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tmp1aa</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;niaf,menf-&gt;meai&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNaF,meNF-&gt;meai&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIaF,MFne-&gt;MeaI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">tmp1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNfA,mfNE-&gt;mEAi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">tmp1bb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIAF,MENF-&gt;MEAI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfA,MEnf-&gt;MEAI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

        <span class="n">aebi</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,meai-&gt;aebi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">ovvo</span><span class="o">+</span><span class="n">tmp1aa</span><span class="p">))</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebi</span>

        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mEAi-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="o">-</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">tmp1ba</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MeaI-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="o">-</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">tmp1ab</span><span class="p">)</span>

        <span class="n">AEBI</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MEAI-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">OVVO</span><span class="o">+</span><span class="n">tmp1bb</span><span class="p">))</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">AEBI</span>

    <span class="c1"># Remaining terms</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;aebi&#39;</span><span class="p">,</span><span class="n">fova</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2aa</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,iMbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">fovb</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,mIaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">fova</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,MIAB-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">fovb</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2bb</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

        <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">get_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,aebf-&gt;aebi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">Wvvvv</span><span class="p">)</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,aeBF-&gt;BFai&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">WvvVV</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,aeBF-&gt;aeBI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">WvvVV</span><span class="p">)</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,AEBF-&gt;AEBI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">WVVVV</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovoo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ooOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OOov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">OVoo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meni,mnab-&gt;aebi&#39;</span><span class="p">,</span><span class="n">ovoo</span><span class="p">,</span><span class="n">tauaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEni,nMbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">OVoo</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,mNbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">ooOV</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNI,mNaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">ovOO</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,nMaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">OOov</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MENI,MNAB-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">OVOO</span><span class="p">,</span><span class="n">taubb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wvvvo</span><span class="p">,</span> <span class="n">WvvVO</span><span class="p">,</span> <span class="n">WVVvo</span><span class="p">,</span> <span class="n">WVVVO</span></div>



<div class="viewcode-block" id="Woooo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Woooo">[docs]</a>
<span class="k">def</span> <span class="nf">Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">tau_aa</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">,</span> <span class="n">tau_bb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aaaaJ</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie, xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie, xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="c1">#tmp_aabbJ = einsum(&#39;xje, ymine-&gt;yxminj&#39;, t1b, eris.ooOV[km,:,kn])</span>
            <span class="c1">#tmp_bbaaJ = einsum(&#39;xje, ymine-&gt;yxminj&#39;, t1a, eris.OOov[km,:,kn])</span>
            <span class="c1">#tmp_abbaJ = -einsum(&#39;yie,xmjne-&gt;yxminj&#39;, t1b, eris.ooOV[km,:,kn])</span>
            <span class="n">tmp_baabJ</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie,xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aabbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aaaaJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bbbbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aabbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp_baabJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">WOOOO</span> <span class="o">-</span> <span class="n">WOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>

            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;minj&#39;</span><span class="p">,</span> <span class="n">tau_aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span>      <span class="n">ovov</span><span class="p">)</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IJEF,MENF-&gt;MINJ&#39;</span><span class="p">,</span> <span class="n">tau_bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span>      <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,meNF-&gt;miNJ&#39;</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>

    <span class="n">WOOoo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Woooo</span><span class="p">,</span> <span class="n">WooOO</span><span class="p">,</span> <span class="n">WOOoo</span><span class="p">,</span> <span class="n">WOOOO</span></div>


<div class="viewcode-block" id="Woovo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Woovo">[docs]</a>
<span class="k">def</span> <span class="nf">Woovo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Woovo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,jnbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,jNbE-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,nJeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,JNBE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MINE,jNbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,jnbe-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MINE,JNBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,nJeB-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="c1"># P(ij)</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mjne,inbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mjNE,iNbE-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NJme,iNeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njME,nIbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJNE,INBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJne,nIeB-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>

        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ovVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">OVvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">ovvo</span><span class="p">)</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,meBJ-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">ovVO</span><span class="p">)</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEbj-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">OVvo</span><span class="p">)</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEBJ-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">OVVO</span><span class="p">)</span>
        <span class="c1">#P(ij)</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mebi-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">ovvo</span><span class="p">)</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,miBE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,MIbe-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,MEBI-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">OVVO</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kf</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,njbf,menf-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">-</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,jNbF,meNF-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,nJfB,menf-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">+</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,NJBF,meNF-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,jNbF,MENF-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">+</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,njbf,MEnf-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,NJBF,MENF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,nJfB,MEnf-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>
            <span class="c1">#P(ij)</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kf</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,nibf,menf-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">-</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,iNbF,meNF-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,iNfB,mfNE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,nIbF,MFne-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,NIBF,MENF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span>
                                <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,nIfB,MEnf-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]))</span>

    <span class="n">Fme</span><span class="p">,</span> <span class="n">FME</span> <span class="o">=</span> <span class="n">Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">Wminj</span><span class="p">,</span> <span class="n">WmiNJ</span><span class="p">,</span> <span class="n">WMInj</span><span class="p">,</span> <span class="n">WMINJ</span> <span class="o">=</span> <span class="n">Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>

        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">Fme</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,iJeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">Fme</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,jIbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">FME</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,IJBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">FME</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, minj-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">Wminj</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB, miNJ-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WmiNJ</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njMI-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WmiNJ</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">km</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB, MINJ-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WMINJ</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,iJeF-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,jIfE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEBF,IJEF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovo</span><span class="p">,</span> <span class="n">WooVO</span><span class="p">,</span> <span class="n">WOOvo</span><span class="p">,</span> <span class="n">WOOVO</span></div>



<div class="viewcode-block" id="Wooov">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Wooov">[docs]</a>
<span class="k">def</span> <span class="nf">Wooov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>

    <span class="n">Wooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">WOOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">WOOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">Wooov</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif,xyzmfne-&gt;xyzmine&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif, zyxnfme-&gt;xyzmine&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="n">WooOV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif,xyzmfNE-&gt;xyzmiNE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
    <span class="n">WOOov</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF,xyzMFne-&gt;xyzMIne&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">)</span>
    <span class="n">WOOOV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF,xyzMFNE-&gt;xyzMINE&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF, zyxNFME-&gt;xyzMINE&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Wooov</span><span class="p">,</span> <span class="n">WooOV</span><span class="p">,</span> <span class="n">WOOov</span><span class="p">,</span> <span class="n">WOOOV</span></div>


<div class="viewcode-block" id="Wovvo">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Wovvo">[docs]</a>
<span class="k">def</span> <span class="nf">Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">cc_Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,mfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,meNF-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MENF-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MFNE-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,MEnf-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,menf-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,mfne-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,meNF-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,MENF-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,MFNE-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,MEnf-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span></div>


<div class="viewcode-block" id="W1oovv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.W1oovv">[docs]</a>
<span class="k">def</span> <span class="nf">W1oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">kl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                    <span class="n">kc</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kl</span><span class="p">]</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lckd,ilbc-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ldkc,ilbc-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LCkd,iLbC-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                    <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kcLD,iLcB-&gt;kiBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kl</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">])</span>
                    <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KCld,lIbC-&gt;KIbd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kl</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LCKD,ILBC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LDKC,ILBC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lcKD,lIcB-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kc</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span></div>


<div class="viewcode-block" id="W2oovv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.W2oovv">[docs]</a>
<span class="k">def</span> <span class="nf">W2oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WWooov</span><span class="p">,</span> <span class="n">WWooOV</span><span class="p">,</span> <span class="n">WWOOov</span><span class="p">,</span> <span class="n">WWOOOV</span> <span class="o">=</span> <span class="n">Wooov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kild,lb-&gt;kibd&#39;</span><span class="p">,</span><span class="n">WWooov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kiLD,LB-&gt;kiBD&#39;</span><span class="p">,</span><span class="n">WWooOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KIld,lb-&gt;KIbd&#39;</span><span class="p">,</span><span class="n">WWOOov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KILD,LB-&gt;KIBD&#39;</span><span class="p">,</span><span class="n">WWOOOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>

                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ckdb,ic-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;dkcb,ic-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ckDB,ic-&gt;kiBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;CKdb,IC-&gt;KIbd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;CKDB,IC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;DKCB,IC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span></div>


<div class="viewcode-block" id="Woovv">
<a class="viewcode-back" href="../../../../pyscf_api_docs/pyscf.pbc.cc.html#pyscf.pbc.cc.kintermediates_uhf.Woovv">[docs]</a>
<span class="k">def</span> <span class="nf">Woovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">W1oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">WWoovv</span><span class="p">,</span> <span class="n">WWooVV</span><span class="p">,</span> <span class="n">WWOOvv</span><span class="p">,</span> <span class="n">WWOOVV</span> <span class="o">=</span> <span class="n">W2oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWoovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span></div>


<span class="c1"># vvvv is a string, (&#39;oooo&#39;, &#39;ooov&#39;, ..., &#39;vvvv&#39;)</span>
<span class="c1"># orbspin can be accessed through general spin-orbital kintermediates eris</span>
<span class="c1"># orbspin = eris.mo_coeff.orbspin</span>
<span class="k">def</span> <span class="nf">_eri_spin2spatial</span><span class="p">(</span><span class="n">chemist_eri_spin</span><span class="p">,</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">,</span> <span class="n">cross_ab</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nocc_b</span> <span class="o">=</span> <span class="n">nocc</span>
    <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocc_a</span> <span class="o">+</span> <span class="n">nocc_b</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbspin</span><span class="p">)</span>
    <span class="n">idxoa</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxob</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxva</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxvb</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">select_idx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxva</span><span class="p">,</span> <span class="n">idxvb</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vvvv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span>

    <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx3a</span><span class="p">,</span> <span class="n">idx3b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">idx4a</span><span class="p">,</span> <span class="n">idx4b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">eri_aaaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="n">eri_aabb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="n">eri_bbaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="n">eri_bbbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="n">eri_abba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri_baab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span>
        <span class="n">eri_aaaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri_aabb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri_bbaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri_bbbb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
            <span class="n">eri_abba</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
            <span class="n">eri_baab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>  <span class="c1"># noqa: E501</span>
    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span><span class="p">,</span> <span class="n">eri_abba</span><span class="p">,</span> <span class="n">eri_baab</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span>

<span class="k">def</span> <span class="nf">_eri_spatial2spin</span><span class="p">(</span><span class="n">eri_aa_ab_ba_bb</span><span class="p">,</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">,</span> <span class="n">cross_ab</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nocc_b</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">nocc</span>
    <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocc_a</span> <span class="o">+</span> <span class="n">nocc_b</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbspin</span><span class="p">)</span>
    <span class="n">idxoa</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxob</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxva</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxvb</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">select_idx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxva</span><span class="p">,</span> <span class="n">idxvb</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vvvv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx3a</span><span class="p">,</span> <span class="n">idx3b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">idx4a</span><span class="p">,</span> <span class="n">idx4b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span><span class="p">,</span> <span class="n">eri_abba</span><span class="p">,</span> <span class="n">eri_baab</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
    <span class="n">eri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_aaaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_aabb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_bbaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_bbbb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
            <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_abba</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
            <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_baab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
    <span class="k">return</span> <span class="n">eri</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, The PySCF Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
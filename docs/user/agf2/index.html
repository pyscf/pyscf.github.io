
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>4.9. Auxiliary second-order Green’s function perturbation theory (AGF2) &#8212; PySCF 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/material.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../../_static/favicon-32x32.png"/>
    <link rel="author" title="About these documents" href="../../about/" />
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="4.10. Multi-configuration self-consistent field (MCSCF)" href="../mcscf/" />
    <link rel="prev" title="4.8. Algebraic diagrammatic construction (ADC) scheme" href="../adc/" /> 
  
   
  
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=amber>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#user/agf2" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../" title="PySCF 2.0.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../../_static/pyscf-logo-white.svg" height="26"
                   alt="PySCF 2.0.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">PySCF 2.0</span>
          <span class="md-header-nav__topic"> 4.9. Auxiliary second-order Green’s function perturbation theory (AGF2) </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search/" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/pyscf/pyscf/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    PySCF
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="../../" class="md-tabs__link">Home</a></li>
            
            <li class="md-tabs__item"><a href="../../overview/" class="md-tabs__link">Overview</a></li>
            
            <li class="md-tabs__item"><a href="../../install/" class="md-tabs__link">Install</a></li>
            
            <li class="md-tabs__item"><a href="../../quickstart/" class="md-tabs__link">Quickstart</a></li>
            
            <li class="md-tabs__item"><a href="../" class="md-tabs__link">User Guide</a></li>
            
            <li class="md-tabs__item"><a href="../../pyscf_api_docs/modules/" class="md-tabs__link">API</a></li>
            
            <li class="md-tabs__item"><a href="../../about/" class="md-tabs__link">About</a></li>
          <li class="md-tabs__item"><a href="../" class="md-tabs__link"><span class="section-number">4. </span>User guide</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../" title="PySCF 2.0.0 documentation" class="md-nav__button md-logo">
      
        <img src="../../_static/pyscf-logo-white.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../"
       title="PySCF 2.0.0 documentation">PySCF 2.0</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/pyscf/pyscf/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    PySCF
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../../overview/" class="md-nav__link">1. Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../install/" class="md-nav__link">2. Install</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../quickstart/" class="md-nav__link">3. Quickstart</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../" class="md-nav__link">4. User Guide</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../gto/" class="md-nav__link">4.1. Molecular structure</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../scf/" class="md-nav__link">4.2. Self-consistent field (SCF) methods</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../dft/" class="md-nav__link">4.3. Density functional theory (DFT)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../mp/" class="md-nav__link">4.4. Second-Order Møller–Plesset Perturbation Theory (MP2)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../gw/" class="md-nav__link">4.5. GW approximation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../ci/" class="md-nav__link">4.6. Configuration interaction (CISD and FCI)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../cc/" class="md-nav__link">4.7. Coupled-cluster theory</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../adc/" class="md-nav__link">4.8. Algebraic diagrammatic construction (ADC) scheme</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> 4.9. Auxiliary second-order Green’s function perturbation theory (AGF2) </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">4.9. Auxiliary second-order Green’s function perturbation theory (AGF2)</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#user-agf2--page-root" class="md-nav__link">4.9. Auxiliary second-order Green’s function perturbation theory (AGF2)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#introduction" class="md-nav__link">4.9.1. Introduction</a>
        </li>
        <li class="md-nav__item"><a href="#theory" class="md-nav__link">4.9.2. Theory</a>
        </li>
        <li class="md-nav__item"><a href="#photoemission-spectra" class="md-nav__link">4.9.3. Photoemission spectra</a>
        </li>
        <li class="md-nav__item"><a href="#restart-a-calculation" class="md-nav__link">4.9.4. Restart a calculation</a>
        </li>
        <li class="md-nav__item"><a href="#parallelisation" class="md-nav__link">4.9.5. Parallelisation</a>
        </li>
        <li class="md-nav__item"><a href="#references" class="md-nav__link">4.9.6. References</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../../_sources/user/agf2.rst.txt">Show Source</a> </li>

  </ul>
</nav>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../mcscf/" class="md-nav__link">4.10. Multi-configuration self-consistent field (MCSCF)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../mrpt/" class="md-nav__link">4.11. Multi-Reference Perturbation Theory (MRPT)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tddft/" class="md-nav__link">4.12. Time-dependent Hartree-Fock and Density Functional Theory</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../solvent/" class="md-nav__link">4.13. Solvation models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../qmmm/" class="md-nav__link">4.14. QM/MM methods</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../df/" class="md-nav__link">4.15. Density fitting (DF)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pbc/" class="md-nav__link">4.16. Periodic boundary conditions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../eph/" class="md-nav__link">4.17. Electron Phonon Matrix</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../lo/" class="md-nav__link">4.18. Localized Orbitals</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../sgx/" class="md-nav__link">4.19. Seminumerical Exchange (SGX)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../geomopt/" class="md-nav__link">4.20. Geometry optimization</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../pyscf_api_docs/pyscf/" class="md-nav__link">5. API</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../interface/" class="md-nav__link">6. Interface</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../about/" class="md-nav__link">7. About</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#user-agf2--page-root" class="md-nav__link">4.9. Auxiliary second-order Green’s function perturbation theory (AGF2)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#introduction" class="md-nav__link">4.9.1. Introduction</a>
        </li>
        <li class="md-nav__item"><a href="#theory" class="md-nav__link">4.9.2. Theory</a>
        </li>
        <li class="md-nav__item"><a href="#photoemission-spectra" class="md-nav__link">4.9.3. Photoemission spectra</a>
        </li>
        <li class="md-nav__item"><a href="#restart-a-calculation" class="md-nav__link">4.9.4. Restart a calculation</a>
        </li>
        <li class="md-nav__item"><a href="#parallelisation" class="md-nav__link">4.9.5. Parallelisation</a>
        </li>
        <li class="md-nav__item"><a href="#references" class="md-nav__link">4.9.6. References</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../../_sources/user/agf2.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
             <div class="section" id="auxiliary-second-order-green-s-function-perturbation-theory-agf2">
<span id="user-agf2"></span><h1><span class="section-number">4.9. </span>Auxiliary second-order Green’s function perturbation theory (AGF2)<a class="headerlink" href="#auxiliary-second-order-green-s-function-perturbation-theory-agf2" title="Permalink to this headline">¶</a></h1>
<p><em>Modules</em>: <code class="xref py py-mod docutils literal notranslate"><span class="pre">agf2</span></code></p>
<div class="section" id="introduction">
<h2><span class="section-number">4.9.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Auxiliary second-order Green’s function perturbation theory (AGF2)
<a class="bibtex reference internal" href="../../develop/agf2_developer/#backhouse2020a" id="id1">[1]</a><a class="bibtex reference internal" href="../../develop/agf2_developer/#backhouse2020b" id="id2">[2]</a> is an iterative, <span class="math notranslate nohighlight">\(\mathcal{O}[N^5]\)</span>
scaling post-Hartree–Fock method primarily intended for the calculation of
charged excitation spectra, ionisation potentials (IPs) and electron affinities
(EAs), with energetics and single-particle static properties also available.
It can also be considered loosely as an iterative approximate ADC(2) method.
One advantage is that the entire spectrum of charged excitations is found
simultaneously, as the full Green’s function is self-consistently optimised.
AGF2 calculations can be performed with or without density fitting, and for
restricted or unrestricted Hartree–Fock references, and is available with
hybrid parallelism capabilities.</p>
<p>Basic usage of AGF2 as given in <a class="reference external" href="https://github.com/pyscf/pyscf/tree/master/examples/agf2/00-simple_agf2.py">examples/agf2/00-simple_agf2.py</a>, as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Author: Oliver J. Backhouse &lt;olbackhouse@gmail.com&gt;</span>
<span class="c1">#         George H. Booth &lt;george.booth@kcl.ac.uk&gt;</span>
<span class="c1">#</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A simple example of restricted AGF2. AGF2 will compute correlation energies, one-particle</span>
<span class="sd">properties and charged excitations / energy levels via an iterated, renormalized perturbation</span>
<span class="sd">theory.</span>

<span class="sd">Default AGF2 corresponds to the AGF2(1,0) method outlined in the papers:</span>
<span class="sd">  - O. J. Backhouse, M. Nusspickel and G. H. Booth, J. Chem. Theory Comput., 16, 1090 (2020).</span>
<span class="sd">  - O. J. Backhouse and G. H. Booth, J. Chem. Theory Comput., 16, 6294 (2020).</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">gto</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span> <span class="n">agf2</span>

<span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="s1">&#39;O 0 0 0; H 0 0 1; H 0 1 0&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;cc-pvdz&#39;</span><span class="p">)</span>

<span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
<span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="n">mf</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Run an AGF2 calculation</span>
<span class="n">gf2</span> <span class="o">=</span> <span class="n">agf2</span><span class="o">.</span><span class="n">AGF2</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-7</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Print the first 3 ionization potentials</span>
<span class="c1"># Note that there is no additional cost to write out larger numbers of excitations.</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">ipagf2</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Print the first 3 electron affinities</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">eaagf2</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="theory">
<h2><span class="section-number">4.9.2. </span>Theory<a class="headerlink" href="#theory" title="Permalink to this headline">¶</a></h2>
<p>In AGF2, one iteratively solves the Dyson equation</p>
<div class="math notranslate nohighlight">
\[G(\omega) = G_0(\omega) + G_0(\omega) \Sigma(\omega) G(\omega),\]</div>
<p>using the self-energy correct through second-order perturbation theory, which
can be written as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\Sigma_{xy}(\omega)
&amp;= \sum_{ija} \frac{ (xi|ja) [ 2 (yi|ja) - (yj|ia) ] }
                   { E_i + E_j - E_a } \\
&amp;+ \sum_{abi} \frac{ (xa|bi) [ 2 (ya|bi) - (yb|ai) ] }
                   { E_a + E_b - E_i }.\end{split}\]</div>
<p>In AGF2, the first two spectral moments of the MP2 self-energy,</p>
<div class="math notranslate nohighlight">
\[\begin{split}T_{xy}^{(0)} &amp;= \sum_{ija} (xi|ja) [ 2 (yi|ja) - (yj|ia) ] \\
             &amp;+ \sum_{abi} (xa|bi) [ 2 (ya|bi) - (yb|ai) ] \\
T_{xy}^{(1)} &amp;= \sum_{ija} (xi|ja) [ 2 (yi|ja) - (yj|ia) ]
                (E_i + E_j - E_a) \\
             &amp;+ \sum_{abi} (xa|bi) [ 2 (ya|bi) - (yb|ai) ]
                (E_a + E_b - E_i),\end{split}\]</div>
<p>are used as a conserved quantity in order to coarse-grain this frequency
dependence as a set of compressed and renormalized <span class="math notranslate nohighlight">\(2p1h\)</span> and <span class="math notranslate nohighlight">\(1p2h\)</span>
states.
These are used to form an effective single-particle Hamiltonian whose size now
only scales with <span class="math notranslate nohighlight">\(\mathcal{O}[N]\)</span>, rather than <span class="math notranslate nohighlight">\(\mathcal{O}[N^3]\)</span> if
the full frequency-dependence was maintained.
This allows Dyson equation to be solved via the hermitian eigenvalue problem</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix} F &amp; v \\ v^\dagger &amp; \epsilon \end{pmatrix}
\phi_{n} = \lambda_{n} \phi_{n},\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(F\)</span> is the Fock matrix, <span class="math notranslate nohighlight">\(\epsilon\)</span> the compressed states
coupling to <span class="math notranslate nohighlight">\(F\)</span> with coupling strength <span class="math notranslate nohighlight">\(v\)</span>, and <span class="math notranslate nohighlight">\(\phi_n\)</span> are
termed the <em>quasi-molecular orbitals</em> (QMOs), which represent the Dyson orbitals
at each iteration, and span both the original MOs and these auxiliary functions.
The QMOs can be reinserted into the self-energy in place of the <span class="math notranslate nohighlight">\(i,j,a\)</span>
and <span class="math notranslate nohighlight">\(a,b,i\)</span> indices, permitting self-consistency to convergence in the
Green’s function with this coarse-grained description of the
frequency-dependence of the self-energy.</p>
<p>Additionally, once projected into the physical space, the QMOs define a
correlated (non-idempotent) density matrix, permitting a further
self-consistency in the Fock matrix in a similar fashion to a Hartree–Fock
calculation.
The correct number of electrons remain in the physical space throughout this
process via optimisation of a chemical potential <span class="math notranslate nohighlight">\(\mu\)</span>.
Finally, we note that self-consistency based on higher-order spectral moments of
either the self-energy or resulting Green’s function at each iteration is
possible, with a limiting behaviour to the traditional second-order Green’s
function method (GF2).
However, numerical investigations have shown that this higher-order
self-consistency leads to a deterioration of results, and therefore the
consistency based on the  first two self-energy spectral moments is the default
behaviour.</p>
</div>
<div class="section" id="photoemission-spectra">
<h2><span class="section-number">4.9.3. </span>Photoemission spectra<a class="headerlink" href="#photoemission-spectra" title="Permalink to this headline">¶</a></h2>
<p>The compression of the effective dynamics performed in AGF2 permits the
calculation of the full spectrum of charged excitations, as no additional
computational effort is required for this (in contrast to iterative eigensolvers
of effective hamiltonians), and the computational effort is therefore
independent of the number of excitations requested.
An example of a calculation which provides the full spectral function can be
found in <a class="reference external" href="https://github.com/pyscf/pyscf/tree/master/examples/agf2/03-photoemission_spectra.py">examples/agf2/03-photoemission_spectra.py</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Author: Oliver J. Backhouse &lt;olbackhouse@gmail.com&gt;</span>
<span class="c1">#         George H. Booth &lt;george.booth@kcl.ac.uk&gt;</span>
<span class="c1">#</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Use a converged AGF2 calculation to build the full photoemission (quasiparticle) spectrum</span>

<span class="sd">Default AGF2 corresponds to the AGF2(1,0) method outlined in the papers:</span>
<span class="sd">  - O. J. Backhouse, M. Nusspickel and G. H. Booth, J. Chem. Theory Comput., 16, 1090 (2020).</span>
<span class="sd">  - O. J. Backhouse and G. H. Booth, J. Chem. Theory Comput., 16, 6294 (2020).</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">gto</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span> <span class="n">agf2</span>

<span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="s1">&#39;O 0 0 0; H 0 0 1; H 0 1 0&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;cc-pvdz&#39;</span><span class="p">)</span>

<span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
<span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="n">mf</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Run an AGF2 calculation</span>
<span class="n">gf2</span> <span class="o">=</span> <span class="n">agf2</span><span class="o">.</span><span class="n">AGF2</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-7</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Access the GreensFunction object and compute the spectrum</span>
<span class="n">gf</span> <span class="o">=</span> <span class="n">gf2</span><span class="o">.</span><span class="n">gf</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">real_freq_spectrum</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>
<span class="c1"># The array `spectrum` is now a length nfreq array of the</span>
<span class="c1"># spectral function -1/pi * Tr[Im[G(\omega + i\eta)]].</span>
<span class="c1"># Note that for UHF AGF2 calculations, the individual gf </span>
<span class="c1"># elements can be passed to real_freq_spectrum in order </span>
<span class="c1"># to obtain the spin-resolved spectra.</span>

<span class="c1"># We can also build the self-energy on the real-frequency axis</span>
<span class="c1"># by accessing the renormalized auxiliary states:</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">gf2</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">gf2</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">chempot</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">gf2</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">coupling</span>
<span class="n">denom</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="mf">1.0</span><span class="n">j</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span>
<span class="n">se</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xk,yk,wk-&gt;wxy&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="mf">1.</span><span class="o">/</span><span class="n">denom</span><span class="p">)</span>
</pre></div>
</div>
<p>Additionally, the Dyson orbitals corresponding to individual excitations are
accessible directly from the method, which can be seen in
<a class="reference external" href="https://github.com/pyscf/pyscf/tree/master/examples/agf2/10-dyson_orbitals.py">examples/agf2/10-dyson_orbitals.py</a>.</p>
</div>
<div class="section" id="restart-a-calculation">
<h2><span class="section-number">4.9.4. </span>Restart a calculation<a class="headerlink" href="#restart-a-calculation" title="Permalink to this headline">¶</a></h2>
<p>The contents of an AGF2 calculation can be dumped to the disk via the familiar
PySCF <code class="docutils literal notranslate"><span class="pre">chkfile</span></code> utilities.
By default, an AGF2 method will inherit the <code class="xref py py-attr docutils literal notranslate"><span class="pre">chkfile</span></code> attribute of the
underlying Hartree–Fock reference object.
An example of restoring an AGF2 calculation from a checkpoint file can be found
in <a class="reference external" href="https://github.com/pyscf/pyscf/tree/master/examples/agf2/04-restart.py">examples/agf2/04-restart.py</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Author: Oliver J. Backhouse &lt;olbackhouse@gmail.com&gt;</span>
<span class="c1">#         George H. Booth &lt;george.booth@kcl.ac.uk&gt;</span>
<span class="c1">#</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">An example of restarting an AGF2 calculation.</span>

<span class="sd">The agf2.chkfile module provides similar functionality to the existing</span>
<span class="sd">chkfile utilities in pyscf, but prevents failure during MPI runs.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">gto</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span> <span class="n">agf2</span><span class="p">,</span> <span class="n">lib</span>

<span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="s1">&#39;O 0 0 0; H 0 0 1; H 0 1 0&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;cc-pvdz&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
<span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="c1"># if we are using MPI, we only want pyscf to save a chkfile on the root process:</span>
<span class="k">if</span> <span class="n">agf2</span><span class="o">.</span><span class="n">mpi_helper</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">chkfile</span> <span class="o">=</span> <span class="s1">&#39;agf2.chk&#39;</span>
<span class="n">mf</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Run an AGF2 calculation:</span>
<span class="n">gf2</span> <span class="o">=</span> <span class="n">agf2</span><span class="o">.</span><span class="n">AGF2</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-7</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">max_cycle</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">gf2</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Restore the Mole and SCF first</span>
<span class="n">mol</span> <span class="o">=</span> <span class="n">agf2</span><span class="o">.</span><span class="n">chkfile</span><span class="o">.</span><span class="n">load_mol</span><span class="p">(</span><span class="s1">&#39;agf2.chk&#39;</span><span class="p">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
<span class="n">mf</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">agf2</span><span class="o">.</span><span class="n">chkfile</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;agf2.chk&#39;</span><span class="p">,</span> <span class="s1">&#39;scf&#39;</span><span class="p">))</span>

<span class="c1"># Restore the AGF2 calculation</span>
<span class="n">gf2a</span> <span class="o">=</span> <span class="n">agf2</span><span class="o">.</span><span class="n">AGF2</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
<span class="n">gf2a</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">agf2</span><span class="o">.</span><span class="n">chkfile</span><span class="o">.</span><span class="n">load_agf2</span><span class="p">(</span><span class="s1">&#39;agf2.chk&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">gf2a</span><span class="o">.</span><span class="n">max_cycle</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">gf2a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="parallelisation">
<h2><span class="section-number">4.9.5. </span>Parallelisation<a class="headerlink" href="#parallelisation" title="Permalink to this headline">¶</a></h2>
<p>The AGF2 module supports both MPI an OpenMP parallelisation in an aim to provide
a scalable method applicable to interesting problems in quantum chemistry.
Furthermore, the dominant scaling step is embarrassingly parallel.
Distribution of computational load is handled by the optional dependency
<code class="docutils literal notranslate"><span class="pre">mpi4py</span></code>, and will run without MPI using OpenMP threads if an installation
cannot be found.</p>
</div>
<div class="section" id="references">
<h2><span class="section-number">4.9.6. </span>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p id="bibtex-bibliography-user/agf2-0"><dl class="citation">
<dt class="bibtex label" id="backhouse2020a"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Oliver J. Backhouse, Max Nusspickel, and George H. Booth. Wave function perspective and efficient truncation of renormalized second-order perturbation theory. <em>J. Chem. Theory Comput.</em>, 16(2):1090–1104, 2020. <a class="reference external" href="https://doi.org/10.1021/acs.jctc.9b01182">doi:10.1021/acs.jctc.9b01182</a>.</p>
</dd>
<dt class="bibtex label" id="backhouse2020b"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Oliver J. Backhouse and George H. Booth. Efficient excitations and spectra within a perturbative renormalization approach. <em>J. Chem. Theory Comput.</em>, 16(10):6294–6304, 2020. <a class="reference external" href="https://doi.org/10.1021/acs.jctc.0c00701">doi:10.1021/acs.jctc.0c00701</a>.</p>
</dd>
</dl>
</p>
</div>
</div>

<div class="section">
   
</div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="../adc/" title="4.8. Algebraic diagrammatic construction (ADC) scheme"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> <span class="section-number">4.8. </span>Algebraic diagrammatic construction (ADC) scheme </span>
              </div>
            </a>
          
          
            <a href="../mcscf/" title="4.10. Multi-configuration self-consistent field (MCSCF)"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> <span class="section-number">4.10. </span>Multi-configuration self-consistent field (MCSCF) </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2015-2021, The PySCF Developers.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>
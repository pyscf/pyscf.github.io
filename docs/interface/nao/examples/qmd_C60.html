
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>nao.examples.qmd_C60 — NAO Examples: QMD C60 &#8212; PySCF 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/material.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../../../_static/favicon-32x32.png"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="7. About" href="../../../about.html" />
    <link rel="prev" title="Interfacing with ASE and Siesta" href="ase.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=amber>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#interface/nao/examples/qmd_C60" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../index.html" title="PySCF 2.0.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../../../_static/pyscf-logo-white.svg" height="26"
                   alt="PySCF 2.0.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">PySCF 2.0</span>
          <span class="md-header-nav__topic"> nao.examples.qmd_C60 — NAO Examples: QMD C60 </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../search.html" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/pyscf/pyscf/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    PySCF
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../../"versions.json"",
        target_loc = "../../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="../../../index.html" class="md-tabs__link">Home</a></li>
            
            <li class="md-tabs__item"><a href="../../../overview.html" class="md-tabs__link">Overview</a></li>
            
            <li class="md-tabs__item"><a href="../../../install.html" class="md-tabs__link">Install</a></li>
            
            <li class="md-tabs__item"><a href="../../../quickstart.html" class="md-tabs__link">Quickstart</a></li>
            
            <li class="md-tabs__item"><a href="../../../user.html" class="md-tabs__link">User Guide</a></li>
            
            <li class="md-tabs__item"><a href="../../../pyscf_api_docs/modules.html" class="md-tabs__link">API</a></li>
            
            <li class="md-tabs__item"><a href="../../../about.html" class="md-tabs__link">About</a></li>
          <li class="md-tabs__item"><a href="../../../interface.html" class="md-tabs__link"><span class="section-number">6. </span>Interfaces</a></li>
          <li class="md-tabs__item"><a href="../../nao.html" class="md-tabs__link"><span class="section-number">6.8. </span><code class="xref py py-mod docutils literal notranslate"><span class="pre">nao</span></code> — Numerical Atomic Orbitals</a></li>
          <li class="md-tabs__item"><a href="../examples.html" class="md-tabs__link"><span class="section-number">6.8.4. </span>nao.examples — NAO Examples</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../index.html" title="PySCF 2.0.0 documentation" class="md-nav__button md-logo">
      
        <img src="../../../_static/pyscf-logo-white.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../index.html"
       title="PySCF 2.0.0 documentation">PySCF 2.0</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/pyscf/pyscf/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    PySCF
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../../../overview.html" class="md-nav__link">Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../install.html" class="md-nav__link">2. Install</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../quickstart.html" class="md-nav__link">Quickstart</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../user.html" class="md-nav__link">User Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../pyscf_api_docs/pyscf.html" class="md-nav__link">5. API</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../interface.html" class="md-nav__link">6. Interface</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../../dftd3.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">dftd3</span></code> — DFT with D3 dispersion correction</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../geomopt.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">geomopt</span></code> — Geometry optimization</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../dmrgscf.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">dmrgscf</span></code> — DMRG and DMRG-SCF/CASSCF</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../fciqmcscf.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">fciqmcscf</span></code> — Full configuration interaction quantum Monte Carlo (FCIQMC)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../cornell_shci.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">cornell_shci</span></code> — Semistochastic heat-bath configuration interaction (SHCI)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../shciscf.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shciscf</span></code> — Semistochastic heat bath configuration interaction (SHCI)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../icmpspt.html" class="md-nav__link"><code class="xref py py-mod docutils literal notranslate"><span class="pre">icmpspt</span></code> — Internal-contracted MPS perturbation method</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../nao.html" class="md-nav__link">6.8. <code class="xref py py-mod docutils literal notranslate"><span class="pre">nao</span></code> — Numerical Atomic Orbitals</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../about.html" class="md-nav__link">7. About</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../../../_sources/interface/nao/examples/qmd_C60.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  
<span id="nao-examples-qmd-c60"></span><h1 id="interface-nao-examples-qmd-c60--page-root">nao.examples.qmd_C60 — NAO Examples: QMD C60<a class="headerlink" href="#interface-nao-examples-qmd-c60--page-root" title="Permalink to this headline">¶</a></h1>
<p>A demonstration of the Nao module used to calculate the polarizability
of C60 at rooms temperature using Quantum Molecular Dynamic (QMD).
The relaxation and the ground state calculations are done using the Siesta
program. This example will calculate the geometries of 5000 steps of C60 using Siesta
and the polarizability will be obtained by calculating 200 steps. This example MUST be
done on a server because it will perform 200 calculations. This example has been done
for the <a class="reference external" href="https://wiki.archlinux.org/index.php/TORQUE">Torque</a> resources manager and will
need to be adapted to your case before to run.</p>
<p>To start the calculations, we first need to generate the 5000 geometries using Molecular
Dynamic (MD) with temperature controlled by means of a Nosé thermostat. For this we use
the following <a class="reference external" href="siesta_C60_thermal.fdf">siesta</a> input file,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SystemLabel</span>                <span class="n">siesta</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">EnergyShift</span>            <span class="mi">50</span> <span class="n">meV</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisSize</span>              <span class="n">DZP</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">SoftDefault</span>            <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisType</span>              <span class="n">split</span>


<span class="n">XC</span><span class="o">.</span><span class="n">functional</span>     <span class="n">GGA</span> 
<span class="n">XC</span><span class="o">.</span><span class="n">authors</span>        <span class="n">PBE</span> 

<span class="n">WriteIonPlotFiles</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">WriteCoorXmol</span>    <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">WriteMDXmol</span>      <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="o">%</span><span class="n">include</span> <span class="s2">"C60_org.fdf"</span>

<span class="n">AtomCoorFormatOut</span>  <span class="n">Ang</span>

<span class="n">DM</span><span class="o">.</span><span class="n">UseSaveDM</span>               <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">DM</span><span class="o">.</span><span class="n">Tolerance</span>               <span class="mf">0.0001</span>
<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.25</span>
<span class="n">MaxSCFIterations</span>           <span class="mi">400</span>
<span class="n">DM</span><span class="o">.</span><span class="n">NumberPulay</span>             <span class="mi">4</span>

<span class="n">MD</span><span class="o">.</span><span class="n">TypeOfRun</span>               <span class="n">Nose</span> 
<span class="n">MD</span><span class="o">.</span><span class="n">InitialTemperature</span>      <span class="mi">300</span> <span class="n">K</span>
<span class="n">MD</span><span class="o">.</span><span class="n">TargetTemperature</span>       <span class="mi">300</span> <span class="n">K</span>
<span class="n">MD</span><span class="o">.</span><span class="n">NumCGsteps</span>              <span class="mi">5000</span>
<span class="n">MD</span><span class="o">.</span><span class="n">FinalTimeStep</span>           <span class="mi">5000</span>
<span class="n">UseSaveData</span>               <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="n">MeshCutOff</span>                <span class="mi">250</span> <span class="n">Ry</span>
<span class="n">MD</span><span class="o">.</span><span class="n">UseSaveXV</span>             <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="n">SaveRho</span>                  <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">COOP</span><span class="o">.</span><span class="n">Write</span>               <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">WriteDenchar</span>             <span class="o">.</span><span class="n">false</span><span class="o">.</span>

</pre></div>
</div>
<p>The file containing the position of the atoms can be downloaded with the following
<a class="reference external" href="C60_org.fdf">link</a>.</p>
<dl class="simple">
<dt>You run this calculation with the normal siesta command (don’t forget the <em>C.psf</em> file)::</dt><dd><p>siesta &lt; siesta_C60_thermal.fdf &gt; siesta.out</p>
</dd>
</dl>
<p>or with a bash script if you run on a server.
Once, this first calculation finish you will be left with a siesta.ANI file containing the
geometry at each time step. We will first generate the xyz files corresponding to the
geometries for comomdity,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

fname=${1:-siesta.ANI}
suffi=${2:-0}
echo ".ANI file with MM geometries            : " $fname
echo "Suffix to choose geometries for QM part : " $suffi

mkdir -p xyz
echo "cp $fname xyz/"
cp $fname xyz/
echo "cd xyz"
cd xyz
LIT=`head -n1 $fname` 
NLINES_PER_FILE=$(expr $LIT + 2)
echo "rm x*"
rm x*
echo "split -l $NLINES_PER_FILE -d -a 6 $fname"
split -l $NLINES_PER_FILE -d -a 6 $fname
echo "xyz2fdf.py x0*$suffi &gt; xyz2fdf.py.out"
xyz2fdf.py x0*$suffi &amp;&gt; xyz2fdf.py.out
cd ..
ls xyz/*.fdf
</pre></div>
</div>
<p>This will create a folder xyz containing the 5000 generated geometries. We need then to
generate the fdf geometries file for siesta:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">cyz</span>
<span class="n">python</span> <span class="n">xyz2fdf</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p><a class="reference external" href="xyz2fdf.py">xyz2fdf.py</a> is a small python script that will generate the geometries for 200 calculations
from the 5000 previous geometries because 5000 is a bit too much. The script look like,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ase.io</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">def</span> <span class="nf">write_geofdf</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">"geo.fdf"</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ase.data</span> <span class="kn">import</span> <span class="n">chemical_symbols</span>

    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"NumberOfAtoms   </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"NumberOfSpecies </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span><span class="p">))))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'%block ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">species_label</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span><span class="p">)):</span>
        <span class="n">species_label</span><span class="p">[</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">nb</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'  </span><span class="si">{0}</span><span class="s1">  </span><span class="si">{1}</span><span class="s1">  '</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span><span class="o">+</span> <span class="n">chemical_symbols</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%e</span><span class="s2">ndblock ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"AtomicCoordinatesFormat  Ang</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"%block AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">position</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">{0:.6f}</span><span class="s2">  </span><span class="si">{1:.6f}</span><span class="s2">  </span><span class="si">{2:.6f}</span><span class="s2">  </span><span class="si">{3}</span><span class="s2"> </span><span class="si">{4}</span><span class="s2">  "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">species_label</span><span class="p">[</span><span class="n">atm</span><span class="o">.</span><span class="n">symbol</span><span class="p">],</span> <span class="n">ia</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">atm</span><span class="o">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%e</span><span class="s2">ndblock AtomicCoordinatesAndAtomicSpecies"</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz_range</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"00000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"0000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"00</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"xyz too large?? </span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>

    <span class="n">path</span> <span class="o">=</span> <span class="s2">"calc_"</span> <span class="o">+</span> <span class="n">num</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">"x"</span><span class="o">+</span><span class="n">num</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"mkdir "</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">write_geofdf</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">path</span><span class="o">+</span><span class="s2">"/geo.fdf"</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"cp siesta_C60.fdf "</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"cp C.psf "</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The script will generate the siesta input files in different trajectory, don’t forget to add in
the xyz directory the <a class="reference external" href="siesta_C60.fdf">siesta input</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SystemLabel</span>                <span class="n">siesta</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">EnergyShift</span>            <span class="mi">50</span> <span class="n">meV</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisSize</span>              <span class="n">DZP</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">SoftDefault</span>            <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisType</span>              <span class="n">split</span>


<span class="n">XC</span><span class="o">.</span><span class="n">functional</span>     <span class="n">GGA</span> 
<span class="n">XC</span><span class="o">.</span><span class="n">authors</span>        <span class="n">PBE</span> 

<span class="o">%</span><span class="n">include</span> <span class="s2">"geo.fdf"</span>

<span class="n">AtomCoorFormatOut</span>  <span class="n">Ang</span>

<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.01</span>
<span class="n">DM</span><span class="o">.</span><span class="n">Tolerance</span>               <span class="mf">0.0001</span>
<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.25</span>
<span class="n">DM</span><span class="o">.</span><span class="n">NumberPulay</span>             <span class="mi">4</span>
<span class="n">MaxSCFIterations</span>           <span class="mi">400</span>

<span class="n">MD</span><span class="o">.</span><span class="n">TypeOfRun</span>               <span class="n">CG</span> 
<span class="n">MD</span><span class="o">.</span><span class="n">NumCGsteps</span>              <span class="mi">0</span>
<span class="n">MD</span><span class="o">.</span><span class="n">MaxForceTol</span>     <span class="mf">0.02</span>   <span class="n">eV</span><span class="o">/</span><span class="n">Ang</span>

<span class="n">SolutionMethod</span>     <span class="n">Diagon</span>

<span class="n">MeshCutOff</span>                <span class="mi">250</span> <span class="n">Ry</span>

<span class="n">WriteCoorXmol</span>     <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">WriteDenchar</span>      <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">COOP</span><span class="o">.</span><span class="n">Write</span>        <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">XML</span><span class="o">.</span><span class="n">Write</span>         <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
</pre></div>
</div>
<dl class="simple">
<dt>After running the xyz2fdf.py script you should have 200 folders containing the 3 input files,</dt><dd><ul class="simple">
<li><p>siesta_C60.fdf</p></li>
<li><p>geo.fdf</p></li>
<li><p>C.psf</p></li>
</ul>
</dd>
</dl>
<p>I advise you to create a new folder, and to copy all the calculations input into this new folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">..</span>
<span class="n">mkdir</span> <span class="n">calculations</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="n">xyz</span><span class="o">/</span><span class="n">calc_</span><span class="o">*</span> <span class="n">calculations</span>
<span class="n">cd</span> <span class="n">calculations</span>
</pre></div>
</div>
<p>Now we will need script to perform the siesta and nao calculations. Here, I will perform in total 50
jobs, each running 4 calculations. Each jobs will be using 6 cpus. I’m assuming that you are using
the Torque managing system. We will use two python script to perform the calculations,</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="submit_jobs.py">submit_jobs.py</a></p></li>
<li><p><a class="reference external" href="calc_polarizability.py">calc_polarizability.py</a></p></li>
</ul>
</div></blockquote>
<p>The first one is the script that you call in order to submit the 200 jobs and it call the second
script <em>calc_polarizability.py</em>. This second script will perform the siesta and nao calculations
for each configurations.</p>
<p>submit_jobs.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="c1"># The bash script for Torque</span>
<span class="n">script</span> <span class="o">=</span> <span class="s2">"""#!/bin/bash  </span>
<span class="s2">#PBS -q parallel</span>
<span class="s2">#PBS -l nodes=1:ppn=6</span>
<span class="s2">#PBS -l mem=5gb</span>
<span class="s2">#PBS -l cput=400:00:00</span>
<span class="s2">#PBS -N calc_C60</span>


<span class="s2">ulimit -s unlimited</span>

<span class="s2">export NPROCS=`wc -l &lt; $PBS_NODEFILE`</span>
<span class="s2">export OMP_NUM_THREADS=$</span><span class="si">{NPROCS}</span><span class="s2"></span>
<span class="s2">export PATH="/Path/To/Python/binary:$PATH" </span>
<span class="s2">export LD_LIBRARY_PATH="/Path/To/Needed/Library:$LD_LIBRARY_PATH" # libxc, libcint, libxcfun</span>
<span class="s2">export PYTHONPATH="/Path/To/Pyscf:$PYTHONPATH"</span>

<span class="s2"># ASE necessay for using ase.units</span>
<span class="s2">#ASE</span>
<span class="s2">export ASE_HOME=/Path/To/ASE</span>
<span class="s2">export PYTHONPATH="$</span><span class="si">{ASE_HOME}</span><span class="s2">:$PYTHONPATH"</span>
<span class="s2">export PATH="$</span><span class="si">{ASE_HOME}</span><span class="s2">/tools:$PATH"</span>

<span class="s2"># you may need to change the job directory</span>
<span class="s2">export LSCRATCH_DIR=/scratch/$USER/jobs/$PBS_JOBID</span>
<span class="s2">mkdir -p $LSCRATCH_DIR</span>
<span class="s2">cd $PBS_O_WORKDIR</span>

<span class="s2"># load the right module depending your pyscfi/siesta compilation</span>
<span class="s2"># you better to use the same compiler for both program to avoid problems</span>
<span class="s2">ml purge</span>
<span class="s2">ml load intel/2015b FFTW/3.3.4-intel-2015b</span>
<span class="s2">"""</span>

<span class="c1"># the range of our 200 calculations</span>
<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
    
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">step</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">calcs</span> <span class="o">=</span> <span class="n">xyz_range</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">include</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"calc_polarizability.py"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">calcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">"00000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">"0000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">"000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">"00</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"xyz too large?? </span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
        <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"calc_"</span><span class="o">+</span><span class="n">num</span><span class="p">)</span>

    <span class="n">fcalc</span> <span class="o">=</span> <span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ecalc</span> <span class="o">=</span> <span class="n">calcs</span><span class="p">[</span><span class="n">calcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">script</span>
    <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"cp -r "</span> <span class="o">+</span> <span class="n">files</span> <span class="o">+</span> <span class="s2">" $LSCRATCH_DIR</span><span class="se">\n</span><span class="s2">"</span>
        
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"cd $LSCRATCH_DIR</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"./calc_polarizability.py --np $</span><span class="si">{NPROCS}</span><span class="s2"> "</span> <span class="o">+</span> <span class="s2">"--start </span><span class="si">{0}</span><span class="s2"> --end </span><span class="si">{1}</span><span class="s2"> &gt;&amp; calc_</span><span class="si">{0}</span><span class="s2">to</span><span class="si">{1}</span><span class="s2">.out</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fcalc</span><span class="p">,</span> <span class="n">ecalc</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"export RESULTS_DIR=$PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"mkdir -p $RESULTS_DIR</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">"cp -r * $RESULTS_DIR</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">"run.calc_C60_</span><span class="si">{0}</span><span class="s2">to_</span><span class="si">{1}</span><span class="s2">.sh"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fcalc</span><span class="p">,</span> <span class="n">ecalc</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="c1"># write bash script</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    
    <span class="c1"># submit job to Torque</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"qsub "</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>calc_polarizability.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/Path/To/Python/binary</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyscf.nao</span> <span class="kn">import</span> <span class="n">tddft_iter</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">ase.units</span> <span class="kn">import</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ha</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="k">def</span> <span class="nf">run_tddft_iter</span><span class="p">():</span>
  <span class="n">t1</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">td</span> <span class="o">=</span> <span class="n">tddft_iter</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">"siesta"</span><span class="p">,</span> <span class="n">iter_broadening</span><span class="o">=</span><span class="mf">0.0035</span><span class="o">/</span><span class="n">Ha</span><span class="p">,</span> <span class="n">xc_code</span><span class="o">=</span><span class="s1">'LDA,PZ'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tddft_iter_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">tol_loc</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">tol_biloc</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
  <span class="n">t2</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"time tddft_iter = "</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
  <span class="n">omegas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">2.5E-3</span><span class="p">)</span><span class="o">/</span><span class="n">Ha</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">td</span><span class="o">.</span><span class="n">eps</span>
  <span class="n">t3</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">pxx</span> <span class="o">=</span> <span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">comp_polariz_nonin_ave</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span>
  <span class="n">t4</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"time chi0 = "</span><span class="p">,</span> <span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">)</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">omegas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">omegas</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="n">Ha</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">real</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">imag</span>
  <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">'polarizability_nonin_siesta.avg.txt'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

  <span class="n">t5</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">pxx</span> <span class="o">=</span> <span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">comp_polariz_inter_ave</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span>
  <span class="n">t6</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"time chi = "</span><span class="p">,</span> <span class="n">t6</span><span class="o">-</span><span class="n">t5</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">omegas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">omegas</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="n">Ha</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">real</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">imag</span>
  <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">'polarizability_inter_siesta.avg.txt'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"nb call:"</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"rf0_ncalls = </span><span class="si">{0}</span><span class="s2">, matvec_ncalls =</span><span class="si">{1}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">rf0_ncalls</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">matvec_ncalls</span><span class="p">))</span>
  <span class="n">t7</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"total time = "</span><span class="p">,</span> <span class="n">t7</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--np'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"number of processor to use"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--start'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"starting calc"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--end'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"end calculation"</span><span class="p">)</span>

<span class="n">args_par</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">args_par</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">mpi_exe</span><span class="o">=</span><span class="s2">"/scratch/mbarbry/intel/intelpython2/bin/mpirun"</span>
<span class="n">siesta_path</span><span class="o">=</span><span class="s2">"/scratch/software/SIESTA/4.0b-485-intel-2015b/siesta"</span>

<span class="n">siesta_exe</span> <span class="o">=</span> <span class="n">mpi_exe</span> <span class="o">+</span> <span class="s2">" -np </span><span class="si">{0}</span><span class="s2"> "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">np</span><span class="p">)</span> <span class="o">+</span> <span class="n">siesta_path</span> <span class="o">+</span> <span class="s2">" &lt; siesta.fdf &gt; siesta.out"</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz_range</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"00000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"0000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"000</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">"00</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"xyz too large?? </span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">"calc_"</span> <span class="o">+</span> <span class="n">num</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># Run siesta</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"export OMP_NUM_THREADS=1"</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">siesta_exe</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Run pyscf.nao</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"export OMP_NUM_THREADS=</span><span class="si">{0}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">np</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">run_tddft_iter</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">"../"</span><span class="p">)</span>
</pre></div>
</div>



          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="ase.html" title="Interfacing with ASE and Siesta"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Interfacing with ASE and Siesta </span>
              </div>
            </a>
          
          
            <a href="../../../about.html" title="7. About"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> <span class="section-number">7. </span>About </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2015-2021, The PySCF Developers.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>
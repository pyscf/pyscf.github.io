
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>nao.examples.qmd_C60 — NAO Examples: QMD C60 &#8212; PySCF</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=92fd9be5" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/pyscf-pst.css?v=ed6b5f64" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=dfec817d"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'interface/nao/examples/qmd_C60';</script>
    <link rel="icon" href="../../../_static/favicon-32x32.png"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo-64x64.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../../_static/logo-64x64.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">PySCF</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributor/index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about.html">
    About
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pyscf/pyscf" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributor/index.html">
    Contributor Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about.html">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pyscf/pyscf" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../tddft_iter.html">nao.tddft_iter — NAO: Iterative Time Dependent Density Functional Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tddft_tem.html">nao.tddft_tem — NAO: Electron Energy Loss Spectroscopy Within TDDFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../comp_spatial_dens.html">nao.comp_spatial_distributions — NAO: Spatial Distribution Density change</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../examples.html">nao.examples — NAO Examples</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ase.html">Interfacing with ASE and Siesta</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">nao.examples.qmd_C60 — NAO Examples: QMD C60</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">nao.examples...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="nao-examples-qmd-c60-nao-examples-qmd-c60">
<span id="nao-examples-qmd-c60"></span><h1>nao.examples.qmd_C60 — NAO Examples: QMD C60<a class="headerlink" href="#nao-examples-qmd-c60-nao-examples-qmd-c60" title="Link to this heading">#</a></h1>
<p>A demonstration of the Nao module used to calculate the polarizability
of C60 at rooms temperature using Quantum Molecular Dynamic (QMD).
The relaxation and the ground state calculations are done using the Siesta
program. This example will calculate the geometries of 5000 steps of C60 using Siesta
and the polarizability will be obtained by calculating 200 steps. This example MUST be
done on a server because it will perform 200 calculations. This example has been done
for the <a class="reference external" href="https://wiki.archlinux.org/index.php/TORQUE">Torque</a> resources manager and will
need to be adapted to your case before to run.</p>
<p>To start the calculations, we first need to generate the 5000 geometries using Molecular
Dynamic (MD) with temperature controlled by means of a Nosé thermostat. For this we use
the following <a class="reference external" href="siesta_C60_thermal.fdf">siesta</a> input file,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SystemLabel</span>                <span class="n">siesta</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">EnergyShift</span>            <span class="mi">50</span> <span class="n">meV</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisSize</span>              <span class="n">DZP</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">SoftDefault</span>            <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisType</span>              <span class="n">split</span>


<span class="n">XC</span><span class="o">.</span><span class="n">functional</span>     <span class="n">GGA</span> 
<span class="n">XC</span><span class="o">.</span><span class="n">authors</span>        <span class="n">PBE</span> 

<span class="n">WriteIonPlotFiles</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">WriteCoorXmol</span>    <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">WriteMDXmol</span>      <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="o">%</span><span class="n">include</span> <span class="s2">&quot;C60_org.fdf&quot;</span>

<span class="n">AtomCoorFormatOut</span>  <span class="n">Ang</span>

<span class="n">DM</span><span class="o">.</span><span class="n">UseSaveDM</span>               <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">DM</span><span class="o">.</span><span class="n">Tolerance</span>               <span class="mf">0.0001</span>
<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.25</span>
<span class="n">MaxSCFIterations</span>           <span class="mi">400</span>
<span class="n">DM</span><span class="o">.</span><span class="n">NumberPulay</span>             <span class="mi">4</span>

<span class="n">MD</span><span class="o">.</span><span class="n">TypeOfRun</span>               <span class="n">Nose</span> 
<span class="n">MD</span><span class="o">.</span><span class="n">InitialTemperature</span>      <span class="mi">300</span> <span class="n">K</span>
<span class="n">MD</span><span class="o">.</span><span class="n">TargetTemperature</span>       <span class="mi">300</span> <span class="n">K</span>
<span class="n">MD</span><span class="o">.</span><span class="n">NumCGsteps</span>              <span class="mi">5000</span>
<span class="n">MD</span><span class="o">.</span><span class="n">FinalTimeStep</span>           <span class="mi">5000</span>
<span class="n">UseSaveData</span>               <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="n">MeshCutOff</span>                <span class="mi">250</span> <span class="n">Ry</span>
<span class="n">MD</span><span class="o">.</span><span class="n">UseSaveXV</span>             <span class="o">.</span><span class="n">true</span><span class="o">.</span>

<span class="n">SaveRho</span>                  <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">COOP</span><span class="o">.</span><span class="n">Write</span>               <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="n">WriteDenchar</span>             <span class="o">.</span><span class="n">false</span><span class="o">.</span>

</pre></div>
</div>
<p>The file containing the position of the atoms can be downloaded with the following
<a class="reference external" href="C60_org.fdf">link</a>.</p>
<dl class="simple">
<dt>You run this calculation with the normal siesta command (don’t forget the <em>C.psf</em> file)::</dt><dd><p>siesta &lt; siesta_C60_thermal.fdf &gt; siesta.out</p>
</dd>
</dl>
<p>or with a bash script if you run on a server.
Once, this first calculation finish you will be left with a siesta.ANI file containing the
geometry at each time step. We will first generate the xyz files corresponding to the
geometries for comomdity,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

fname=${1:-siesta.ANI}
suffi=${2:-0}
echo &quot;.ANI file with MM geometries            : &quot; $fname
echo &quot;Suffix to choose geometries for QM part : &quot; $suffi

mkdir -p xyz
echo &quot;cp $fname xyz/&quot;
cp $fname xyz/
echo &quot;cd xyz&quot;
cd xyz
LIT=`head -n1 $fname` 
NLINES_PER_FILE=$(expr $LIT + 2)
echo &quot;rm x*&quot;
rm x*
echo &quot;split -l $NLINES_PER_FILE -d -a 6 $fname&quot;
split -l $NLINES_PER_FILE -d -a 6 $fname
echo &quot;xyz2fdf.py x0*$suffi &gt; xyz2fdf.py.out&quot;
xyz2fdf.py x0*$suffi &amp;&gt; xyz2fdf.py.out
cd ..
ls xyz/*.fdf
</pre></div>
</div>
<p>This will create a folder xyz containing the 5000 generated geometries. We need then to
generate the fdf geometries file for siesta:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">cyz</span>
<span class="n">python</span> <span class="n">xyz2fdf</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p><a class="reference external" href="xyz2fdf.py">xyz2fdf.py</a> is a small python script that will generate the geometries for 200 calculations
from the 5000 previous geometries because 5000 is a bit too much. The script look like,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ase.io</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">def</span> <span class="nf">write_geofdf</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;geo.fdf&quot;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ase.data</span> <span class="kn">import</span> <span class="n">chemical_symbols</span>

    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;NumberOfAtoms   </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;NumberOfSpecies </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span><span class="p">))))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;%block ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">species_label</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span><span class="p">)):</span>
        <span class="n">species_label</span><span class="p">[</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">nb</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1">  </span><span class="si">{1}</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span><span class="o">+</span> <span class="n">chemical_symbols</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesFormat  Ang</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;%block AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">position</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.6f}</span><span class="s2">  </span><span class="si">{1:.6f}</span><span class="s2">  </span><span class="si">{2:.6f}</span><span class="s2">  </span><span class="si">{3}</span><span class="s2"> </span><span class="si">{4}</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">species_label</span><span class="p">[</span><span class="n">atm</span><span class="o">.</span><span class="n">symbol</span><span class="p">],</span> <span class="n">ia</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">atm</span><span class="o">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock AtomicCoordinatesAndAtomicSpecies&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz_range</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;0000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xyz too large?? </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>

    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;calc_&quot;</span> <span class="o">+</span> <span class="n">num</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="o">+</span><span class="n">num</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;mkdir &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">write_geofdf</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;/geo.fdf&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;cp siesta_C60.fdf &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;cp C.psf &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The script will generate the siesta input files in different trajectory, don’t forget to add in
the xyz directory the <a class="reference external" href="siesta_C60.fdf">siesta input</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SystemLabel</span>                <span class="n">siesta</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">EnergyShift</span>            <span class="mi">50</span> <span class="n">meV</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisSize</span>              <span class="n">DZP</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">SoftDefault</span>            <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="n">PAO</span><span class="o">.</span><span class="n">BasisType</span>              <span class="n">split</span>


<span class="n">XC</span><span class="o">.</span><span class="n">functional</span>     <span class="n">GGA</span> 
<span class="n">XC</span><span class="o">.</span><span class="n">authors</span>        <span class="n">PBE</span> 

<span class="o">%</span><span class="n">include</span> <span class="s2">&quot;geo.fdf&quot;</span>

<span class="n">AtomCoorFormatOut</span>  <span class="n">Ang</span>

<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.01</span>
<span class="n">DM</span><span class="o">.</span><span class="n">Tolerance</span>               <span class="mf">0.0001</span>
<span class="n">DM</span><span class="o">.</span><span class="n">MixingWeight</span>            <span class="mf">0.25</span>
<span class="n">DM</span><span class="o">.</span><span class="n">NumberPulay</span>             <span class="mi">4</span>
<span class="n">MaxSCFIterations</span>           <span class="mi">400</span>

<span class="n">MD</span><span class="o">.</span><span class="n">TypeOfRun</span>               <span class="n">CG</span> 
<span class="n">MD</span><span class="o">.</span><span class="n">NumCGsteps</span>              <span class="mi">0</span>
<span class="n">MD</span><span class="o">.</span><span class="n">MaxForceTol</span>     <span class="mf">0.02</span>   <span class="n">eV</span><span class="o">/</span><span class="n">Ang</span>

<span class="n">SolutionMethod</span>     <span class="n">Diagon</span>

<span class="n">MeshCutOff</span>                <span class="mi">250</span> <span class="n">Ry</span>

<span class="n">WriteCoorXmol</span>     <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">WriteDenchar</span>      <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">COOP</span><span class="o">.</span><span class="n">Write</span>        <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
<span class="n">XML</span><span class="o">.</span><span class="n">Write</span>         <span class="o">.</span><span class="kc">True</span><span class="o">.</span>
</pre></div>
</div>
<dl class="simple">
<dt>After running the xyz2fdf.py script you should have 200 folders containing the 3 input files,</dt><dd><ul class="simple">
<li><p>siesta_C60.fdf</p></li>
<li><p>geo.fdf</p></li>
<li><p>C.psf</p></li>
</ul>
</dd>
</dl>
<p>I advise you to create a new folder, and to copy all the calculations input into this new folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">..</span>
<span class="n">mkdir</span> <span class="n">calculations</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="n">xyz</span><span class="o">/</span><span class="n">calc_</span><span class="o">*</span> <span class="n">calculations</span>
<span class="n">cd</span> <span class="n">calculations</span>
</pre></div>
</div>
<p>Now we will need script to perform the siesta and nao calculations. Here, I will perform in total 50
jobs, each running 4 calculations. Each jobs will be using 6 cpus. I’m assuming that you are using
the Torque managing system. We will use two python script to perform the calculations,</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="submit_jobs.py">submit_jobs.py</a></p></li>
<li><p><a class="reference external" href="calc_polarizability.py">calc_polarizability.py</a></p></li>
</ul>
</div></blockquote>
<p>The first one is the script that you call in order to submit the 200 jobs and it call the second
script <em>calc_polarizability.py</em>. This second script will perform the siesta and nao calculations
for each configurations.</p>
<p>submit_jobs.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="c1"># The bash script for Torque</span>
<span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#!/bin/bash  </span>
<span class="s2">#PBS -q parallel</span>
<span class="s2">#PBS -l nodes=1:ppn=6</span>
<span class="s2">#PBS -l mem=5gb</span>
<span class="s2">#PBS -l cput=400:00:00</span>
<span class="s2">#PBS -N calc_C60</span>


<span class="s2">ulimit -s unlimited</span>

<span class="s2">export NPROCS=`wc -l &lt; $PBS_NODEFILE`</span>
<span class="s2">export OMP_NUM_THREADS=$</span><span class="si">{NPROCS}</span>
<span class="s2">export PATH=&quot;/Path/To/Python/binary:$PATH&quot; </span>
<span class="s2">export LD_LIBRARY_PATH=&quot;/Path/To/Needed/Library:$LD_LIBRARY_PATH&quot; # libxc, libcint, libxcfun</span>
<span class="s2">export PYTHONPATH=&quot;/Path/To/Pyscf:$PYTHONPATH&quot;</span>

<span class="s2"># ASE necessay for using ase.units</span>
<span class="s2">#ASE</span>
<span class="s2">export ASE_HOME=/Path/To/ASE</span>
<span class="s2">export PYTHONPATH=&quot;$</span><span class="si">{ASE_HOME}</span><span class="s2">:$PYTHONPATH&quot;</span>
<span class="s2">export PATH=&quot;$</span><span class="si">{ASE_HOME}</span><span class="s2">/tools:$PATH&quot;</span>

<span class="s2"># you may need to change the job directory</span>
<span class="s2">export LSCRATCH_DIR=/scratch/$USER/jobs/$PBS_JOBID</span>
<span class="s2">mkdir -p $LSCRATCH_DIR</span>
<span class="s2">cd $PBS_O_WORKDIR</span>

<span class="s2"># load the right module depending your pyscfi/siesta compilation</span>
<span class="s2"># you better to use the same compiler for both program to avoid problems</span>
<span class="s2">ml purge</span>
<span class="s2">ml load intel/2015b FFTW/3.3.4-intel-2015b</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># the range of our 200 calculations</span>
<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
    
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">step</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">xyz_range</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">calcs</span> <span class="o">=</span> <span class="n">xyz_range</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">include</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;calc_polarizability.py&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">calcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;0000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xyz too large?? </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
        <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;calc_&quot;</span><span class="o">+</span><span class="n">num</span><span class="p">)</span>

    <span class="n">fcalc</span> <span class="o">=</span> <span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ecalc</span> <span class="o">=</span> <span class="n">calcs</span><span class="p">[</span><span class="n">calcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">25</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">script</span>
    <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;cp -r &quot;</span> <span class="o">+</span> <span class="n">files</span> <span class="o">+</span> <span class="s2">&quot; $LSCRATCH_DIR</span><span class="se">\n</span><span class="s2">&quot;</span>
        
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;cd $LSCRATCH_DIR</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;./calc_polarizability.py --np $</span><span class="si">{NPROCS}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="s2">&quot;--start </span><span class="si">{0}</span><span class="s2"> --end </span><span class="si">{1}</span><span class="s2"> &gt;&amp; calc_</span><span class="si">{0}</span><span class="s2">to</span><span class="si">{1}</span><span class="s2">.out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fcalc</span><span class="p">,</span> <span class="n">ecalc</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;export RESULTS_DIR=$PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;mkdir -p $RESULTS_DIR</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="s2">&quot;cp -r * $RESULTS_DIR</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;run.calc_C60_</span><span class="si">{0}</span><span class="s2">to_</span><span class="si">{1}</span><span class="s2">.sh&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fcalc</span><span class="p">,</span> <span class="n">ecalc</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="c1"># write bash script</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    
    <span class="c1"># submit job to Torque</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;qsub &quot;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>calc_polarizability.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/Path/To/Python/binary</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyscf.nao</span> <span class="kn">import</span> <span class="n">tddft_iter</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">ase.units</span> <span class="kn">import</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ha</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="k">def</span> <span class="nf">run_tddft_iter</span><span class="p">():</span>
  <span class="n">t1</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">td</span> <span class="o">=</span> <span class="n">tddft_iter</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">,</span> <span class="n">iter_broadening</span><span class="o">=</span><span class="mf">0.0035</span><span class="o">/</span><span class="n">Ha</span><span class="p">,</span> <span class="n">xc_code</span><span class="o">=</span><span class="s1">&#39;LDA,PZ&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tddft_iter_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">tol_loc</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">tol_biloc</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
  <span class="n">t2</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time tddft_iter = &quot;</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
  <span class="n">omegas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">2.5E-3</span><span class="p">)</span><span class="o">/</span><span class="n">Ha</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">td</span><span class="o">.</span><span class="n">eps</span>
  <span class="n">t3</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">pxx</span> <span class="o">=</span> <span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">comp_polariz_nonin_ave</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span>
  <span class="n">t4</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time chi0 = &quot;</span><span class="p">,</span> <span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">)</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">omegas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">omegas</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="n">Ha</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">real</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">imag</span>
  <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;polarizability_nonin_siesta.avg.txt&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

  <span class="n">t5</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="n">pxx</span> <span class="o">=</span> <span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">comp_polariz_inter_ave</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span>
  <span class="n">t6</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time chi = &quot;</span><span class="p">,</span> <span class="n">t6</span><span class="o">-</span><span class="n">t5</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">omegas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">omegas</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="n">Ha</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">real</span>
  <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxx</span><span class="o">.</span><span class="n">imag</span>
  <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;polarizability_inter_siesta.avg.txt&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nb call:&quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rf0_ncalls = </span><span class="si">{0}</span><span class="s2">, matvec_ncalls =</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">rf0_ncalls</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">matvec_ncalls</span><span class="p">))</span>
  <span class="n">t7</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total time = &quot;</span><span class="p">,</span> <span class="n">t7</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--np&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of processor to use&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--start&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;starting calc&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--end&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;end calculation&quot;</span><span class="p">)</span>

<span class="n">args_par</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="n">xyz_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">args_par</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">mpi_exe</span><span class="o">=</span><span class="s2">&quot;/scratch/mbarbry/intel/intelpython2/bin/mpirun&quot;</span>
<span class="n">siesta_path</span><span class="o">=</span><span class="s2">&quot;/scratch/software/SIESTA/4.0b-485-intel-2015b/siesta&quot;</span>

<span class="n">siesta_exe</span> <span class="o">=</span> <span class="n">mpi_exe</span> <span class="o">+</span> <span class="s2">&quot; -np </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">np</span><span class="p">)</span> <span class="o">+</span> <span class="n">siesta_path</span> <span class="o">+</span> <span class="s2">&quot; &lt; siesta.fdf &gt; siesta.out&quot;</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz_range</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;0000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;000</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;00</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xyz too large?? </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;calc_&quot;</span> <span class="o">+</span> <span class="n">num</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># Run siesta</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;export OMP_NUM_THREADS=1&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">siesta_exe</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Run pyscf.nao</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;export OMP_NUM_THREADS=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args_par</span><span class="o">.</span><span class="n">np</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">run_tddft_iter</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/pyscf/pyscf.github.io/edit/master/source/interface/nao/examples/qmd_C60.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The PySCF Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>